
センサーのリアルタイムデータとサンプリング周期

SenStickは、センサーのリアルタイムデータの都度送信機能があります。ですが、このリアルタイムデータは、すべてのデータが送られるとは限りません。
SenStickは、BLEのコネクション・インターバルごとに、6パケットまで送信できます。ですから、例えば、コネクション・インターバルが20ミリ秒で、加速度センサーの周期が10ミリ秒であれば、1回のコネクション・インターバルで2つパケットを送ればいいので、データを落とすことはありません。しかしコネクション・インターバルが長い値になったり、他のセンサー・データも送信するなどで、送信できるパケットに収まらない場合、そのデータは落ちます。
取得データをリアルタイムに落とさずに取得したい場合は、ログ読み出しを使います。Senstickは記録中のログをデータが追加されるごとに読み出せます。データ送信が間に合わなくても、ログとして内部に記録されているため、リアルタイムではなくなりますが、随時データを落とすことなく、読み出せます。

センサー・データの取得周期は、計測設定(0x7100+センサ種別)サービスにある、キャラクタリスティクス sampling_period で設定できます。16ビットの符号なしの値です。SenStick内部では、10ミリ秒周期の割り込みで、これを処理します。ですから、周期は10ミリ秒単位で設定します。

サンプリング周期は、最大0.6ミリ秒、後ろにずれることがあります。BLEの通信処理に優先的にプロセッサが割り当てられています。その処理が0.6ミリ秒ほどかかります。このため、センサーのためのタイマー割り込みの開始前、またはタイマー割り込みの処理中に、不定期に、このBLEの通信処理が入る可能性があります。
サンプリングの周期は0.6ミリ秒うしろにずれることがありますが、サンプリングの絶対時間は、ずれることはありません。ファームウェアは、16MHzの水晶クロックを分周して、これから10ミリ秒の割り込みを作っています。そのため、サンプリングの絶対時間がずれることはありません。

このサンプリング周期には、次の制約があります。

加速度、角速度、磁場のサンプリング周期は、20ミリ秒以上が設定できます。ただし、照度または温度湿度センサーが有効の場合は、200ミリ秒以上の値だけが設定できます。もしも照度または温度湿度センサーが有効の場合に、200ミリ秒以下の値を設定しようとすると、エラーとなり、その値は書き込まれません。
および紫外線強度と気圧センサーの周期は、200ミリ秒以上が設定できます。
照度または温度湿度センサーの周期は、200ミリ秒以上が設定できます。ただし、加速度、角速度、磁場のいずれか1つでも、センサーが有効でかつサンプリング周期が200ミリ秒以下のものがあれば、照度または温度湿度センサーを有効にする設定は書き込めません。

注意

加速度、角速度、磁場のサンプリング周期は、20ミリ秒以上が設定できます。
ただし、フラッシュメモリのセクタ消去時間は、動作環境の温度により変わり、この消去時間は、通常は30ミリ秒ですが、85℃では最大120ミリ秒になります。
室温では、センサーのサンプリング周期は、20ミリ秒以上の値が設定できます。
消去時間が120ミリ秒の最大値だと、センサーのサンプリング周期は、40ミリ秒以上です。40ミリ秒より小さな値を指定したときは、ファームウェアが異常終了します。
